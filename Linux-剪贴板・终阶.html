<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Linux 剪贴板・终阶 | Tyrant&#39;s Blog</title>
  <meta name="author" content="Isaac Ge">
  
  <meta name="description" content="It&#39;s just acgtyrant&#39;s blog... or delusion.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Linux 剪贴板・终阶"/>
  <meta property="og:site_name" content="Tyrant&#39;s Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="Tyrant&#39;s Blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Tyrant&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header page-header-inverse ">		
			<h1 class="title title-inverse "> Linux 剪贴板・终阶</h1>
		</div>		
	






<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p><img src="http://i0.hdslb.com/bfs/archive/571003a757179b0b7b0d6112d1717d0959d9db5a.jpg" alt="旷野之息 力之试炼 终阶＋"></p>
<p>我用 Linux 好多年，依然没真正理清 Linux 下剪贴板的用法，因为很多程序的复制粘贴行为都不一样，何况Ｘ还有两种剪贴板，再加上我经常跨机编辑，即 termite+ssh+tmux+neovim，这么多程序叠加在一起，就一直不知道到底怎么复制粘贴好。这不，今天我要在远程主机 yy 上通过 NeoVim 选中里面的内容，复制到另一个远程主机 103 的 NeoVim 上，乱按快捷键一通也没解决。于是终于彻底下定决心搞清 Linux 以及众多程序的剪贴板原理，在此整理并归档研究结论。</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><ul>
<li><p><a href="https://wiki.archlinux.org/index.php/Clipboard" target="_blank" rel="external">https://wiki.archlinux.org/index.php/Clipboard</a></p>
</li>
<li><p><a href="[https://blog.lilydjwg.me/2013/11/24/clipboards-in-x-window.41800.html](https://blog.lilydjwg.me/2013/11/24/clipboards-in-x-window.41800.html">X Window 中的剪贴板</a>)</p>
</li>
</ul>
<p>按这两篇的说法，所谓两种剪贴板 Clipboard 和 Primary selection 都是Ｘ的功能。区别是前者用 Windows 那样的复制粘贴键 <code>ctrl+c/ctrl+v</code>，后者只需选中内容，就可以在别的地方用鼠标中键粘贴。还有 <code>shift+insert</code> 能起到 <code>ctrl+v</code> 的作用，但这键太冷门了就不记了。</p>
<p>此外其实这两个剪贴板都是异步的——只有在粘贴时，才会真正触发复制！我实践发现，哪怕在 Gedit 主动用 <code>ctrl+c</code> 复制后，关掉 Gedit，在 Google Chrome 的地址栏就粘贴不出来任何东西了。 于是 ArchWiki 建议改用剪贴板管理器来解决。此外为了措辞上的方便，下文假设复制粘贴是同步的，比如「复制东西进剪贴板」。</p>
<p>选中也不一定可以复制，除了依云提到的，我还发现 Google Chrome 按 <code>alt+d</code> 选中地址栏的 URL，不能复制；但鼠标双击地址栏全选，能复制。</p>
<h1 id="简化原则"><a href="#简化原则" class="headerlink" title="简化原则"></a>简化原则</h1><p>为了解决如此复杂的剪贴板问题，我需要设定一些简化原则，减轻记忆负担。</p>
<ul>
<li><p>只用 clipboard！从此以后就当 Linux 只存在一种剪贴板。自然不用记住选中却无法复制的例外情况了。primary，不存在。</p>
</li>
<li><p>尽可能地让所有程序的复制粘贴键接近 vim-binding。</p>
</li>
</ul>
<h1 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h1><p>开始整理并归档御用程序如何使用剪贴板的解决方案。</p>
<h2 id="御用剪贴板交互命令・-xclip"><a href="#御用剪贴板交互命令・-xclip" class="headerlink" title="御用剪贴板交互命令・ xclip"></a>御用剪贴板交互命令・ xclip</h2><p>除了用程序本身的复制粘贴键、鼠标选中复制与中键粘贴行为，其实也有现成的命令，能在 Shell 里与Ｘ剪贴板互动。最常见的有两个命令： <a href="[https://askubuntu.com/questions/705620/xclip-vs-xsel](https://askubuntu.com/questions/705620/xclip-vs-xsel">‘xclip’ vs. ‘xsel’</a>)</p>
<p>由于 xsel 已经两年没更新了，而且 GitHub 官方帮助又钦定 xclip，再加上 xclip 比 xsel 顺耳许多了。我决定 xclip 作为御用剪贴板交互命令。</p>
<p>xclip 默认复制进 primary，坑。</p>
<h2 id="御用虚拟终端・-Terminate"><a href="#御用虚拟终端・-Terminate" class="headerlink" title="御用虚拟终端・ Terminate"></a>御用虚拟终端・ Terminate</h2><p><a href="https://wiki.archlinux.org/index.php/Termite" target="_blank" rel="external">https://wiki.archlinux.org/index.php/Termite</a></p>
<p>Termite 像 Vim，有两种模式：Insert 和 Selection。</p>
<p>Insert 模式下，可以直接用鼠标选中内容，但它的行为和 Vim 不一样：仍然处于 Insert 模式！用户可以一边选中内容，一边输入内容。由于虚拟终端和 Shell 紧密相关，不能直接用 <code>ctrl+c/ctrl+v</code>，只能用 <code>ctrl+shift+c/ctrl+shift+v</code> 代替复制粘贴。</p>
<p>按 <code>ctrl+shift+space</code> 可以进入 selection 模式，行为和 Vim 一样，不赘述。</p>
<p>复制会复制到Ｘ剪贴板，我测试了下发现包括 clipboard.</p>
<p>由于我习惯用 Tmux，Termite 的复制粘贴功能其实不重要，无需记忆。不过，我发现 <strong>Termite 的 <code>ctrl+shift+v</code> 在 Tmux 一样有效</strong> ！</p>
<h2 id="御用网络传输协议・-SSH"><a href="#御用网络传输协议・-SSH" class="headerlink" title="御用网络传输协议・ SSH"></a>御用网络传输协议・ SSH</h2><p>既然剪贴板由Ｘ负责，那么我们需要 SSH 能够转发远程主机上的Ｘ程序到本地上，从而让远程主机能与本地的剪贴板互动。信任远程主机的话，<code>alias ssh=&#39;ssh -Y&#39;</code> 即可。</p>
<p>实践证明，我 SSH 到远程主机并开启 Tmux 后，<strong>我可以把 clipboard 的东西通过 Termite 的 <code>ctrl+shifht+v</code> 粘贴进该 Tmux Session 的某 pane 里。</strong></p>
<h2 id="御用终端多路复用器・-Tmux"><a href="#御用终端多路复用器・-Tmux" class="headerlink" title="御用终端多路复用器・ Tmux"></a>御用终端多路复用器・ Tmux</h2><p>由于 Termite 的复制粘贴直接作用于整个虚拟终端的界面上，不分 Tmux 里的 pane，于是需要掌握 Tmux 下能在 pane 复制粘贴行为。</p>
<p>Tmux 也有两种模式。一是常规模式，即用户在 pane 里的行为和单个虚拟终端一样；另一是 copy-mode，为能够在 pane 下滚动历史或复制而服务，其又有两种 binding，一是 Emacs 另一是 Vim，默认用 Emacs binding。</p>
<p>我习惯 vim-like 步骤与行为，自然要重新设置为 Vim Binding： <code>set-window-option -g mode-keys vi</code>。</p>
<p>此外 Tmux 2.4 有重新定义 Key Binding 语法，本文不考虑 Tmux 2.4 之前的旧 Key Binding 语法。</p>
<p>Tmux 原本进入 copy-mode 的默认 key binding 为 <code>prefix+[</code>，太蠢，为保持与 Vim Binding 一致，可以直接修改： <code>bind-key Escape copy-mode # enter copy mode (prefix Escape)</code>，模仿在 Vim 从 Insert 模式退出，进入 Normal 模式的行为。</p>
<p>再继续改造 key bindings：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">bind-key -T copy-mode-vi &apos;v&apos; send-keys -X begin-selection</div><div class="line"></div><div class="line">bind-key -T copy-mode-vi &apos;V&apos; send-keys -X select-line</div><div class="line"></div><div class="line">bind-key -T copy-mode-vi &apos;r&apos; send-keys -X rectangle-toggle</div><div class="line"></div><div class="line">bind-key -T copy-mode-vi &apos;y&apos; send-keys -X copy-pipe-and-cancel &quot;xclip -in -selection clipboard&quot;</div></pre></td></tr></table></figure>
<p>需要注意的是 Tmux copy mode 不支持 Vim Visual 模式 <code>ctrl+v</code> 那样的 block selection，但是可以通过 <code>r</code> 改变 <code>v</code> 的 selection 行为，即从跨行 selection 和 block selection 之间转换。<code>y</code> 则是粘贴进 clipboard 了。</p>
<p>更进一步地像 Vim 那样能滚动浏览 pane 的历史：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># scroll like vim</div><div class="line"></div><div class="line">bind-key -T copy-mode-vi f send-keys page-down</div><div class="line"></div><div class="line">bind-key -T copy-mode-vi b send-keys page-up</div><div class="line"></div><div class="line">bind-key -T copy-mode-vi d send-keys halfpage-down</div><div class="line"></div><div class="line">bind-key -T copy-mode-vi u send-keys halfpage-up</div></pre></td></tr></table></figure>
<p>其实本来还可以加 <code>bind-key p run &quot;xclip -o -sel clip | tmux load-buffer - ; tmux paste-buffer&quot;</code>，不过还是 <code>ctrl+shift+v</code> 粘贴更方便，就不加了。</p>
<h2 id="御用文本编辑器・-NeoVim"><a href="#御用文本编辑器・-NeoVim" class="headerlink" title="御用文本编辑器・ NeoVim"></a>御用文本编辑器・ NeoVim</h2><p>Vim 要有开启 clipboard 编译选项，才支持剪贴板（大概）。据说 Arch Linux 的 vim 就没开启！只能改装 gvim 包了。</p>
<p>好在 NeoVim 支持，但需要额外的依赖，<code>help clipboard</code> 指出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">The presence of a working clipboard tool implicitly enables the &apos;+&apos; and &apos;*&apos;</div><div class="line"></div><div class="line">registers. Nvim looks for these clipboard tools, in order of priority:</div><div class="line"></div><div class="line">- |g:clipboard|</div><div class="line"></div><div class="line">- pbcopy/pbpaste (macOS)</div><div class="line"></div><div class="line">- xsel (if $DISPLAY is set)</div><div class="line"></div><div class="line">- xclip (if $DISPLAY is set)</div><div class="line"></div><div class="line">- lemonade (for SSH) [https://github.com/pocke/lemonade](https://github.com/pocke/lemonade)</div><div class="line"></div><div class="line">- doitclient (for SSH) [http://www.chiark.greenend.org.uk/~sgtatham/doit/](http://www.chiark.greenend.org.uk/~sgtatham/doit/)</div><div class="line"></div><div class="line">- win32yank (Windows)</div><div class="line"></div><div class="line">- tmux (if $TMUX is set)</div></pre></td></tr></table></figure>
<p>显然装 xclip 就行了。</p>
<p>Vim 默认 VISUAL 选中内容不会复制进 primary，这样正好，毕竟 Vim 重在编辑。可以通过 <code>shift+&quot;+y</code> 复制进 clipboard。</p>
<p>至于到底怎么复制粘贴，看 <a href="[https://stackoverflow.com/questions/11489428/how-to-make-vim-paste-from-and-copy-to-systems-clipboard](https://stackoverflow.com/questions/11489428/how-to-make-vim-paste-from-and-copy-to-systems-clipboard">How to make vim paste from (and copy to) system’s clipboard?</a>) 就够了。</p>
<p>最后，如何在 SSH 到远程主机再 Tmux 后再开 NeoVim，如何复制粘贴到本地？简单，<code>ssh -Y</code>，本地和远程主机都装 xclip，跟平常一样复制粘贴。</p>
<h2 id="御用剪贴板管理器・Flicx-Clipboard"><a href="#御用剪贴板管理器・Flicx-Clipboard" class="headerlink" title="御用剪贴板管理器・Flicx Clipboard"></a>御用剪贴板管理器・Flicx Clipboard</h2><p>参见 <a href="[https://www.csslayer.info/wordpress/fcitx-dev/fcitx-clipboard/">Fcitx Clipboard</a>](<a href="https://www.csslayer.info/wordpress/fcitx-dev/fcitx-clipboard/))，在其插件的高级设置里可以把" target="_blank" rel="external">https://www.csslayer.info/wordpress/fcitx-dev/fcitx-clipboard/))，在其插件的高级设置里可以把</a> primary text 关掉。作为剪贴板管理器已经足够好用了。</p>
<blockquote>
<p>Written with <a href="https://stackedit.io/" target="_blank" rel="external">StackEdit</a>.</p>
</blockquote>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/我又双迁移到-NeoVim-了.html" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        

        

    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">Comments</h2>

  
  	 <div id="disqus_thread">
     <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  	 </div>
  
</section>

	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2018 Oct 2 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Linux/">Linux<span>2</span></a></li> <li><a href="/tags/技术/">技术<span>9</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
var disqus_shortname = 'acgtyrant';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2018 Isaac Ge
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
